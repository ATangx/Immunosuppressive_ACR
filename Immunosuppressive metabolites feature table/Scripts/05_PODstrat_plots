#=== SIMPLIFIED POD-STRATIFIED PLOTTING ===

cat("\n=== POD-STRATIFIED METABOLITE PLOTTING ===\n")
cat("Creating plots for POD-stratified significant results\n\n")

# Define POD strata
pod_strata <- list(
  "Early (â‰¤30 days)" = c(0, 30),     # Post transplant periods
  "Mid (31-90 days)" = c(31, 90),   
  "Late (>90 days)" = c(91, Inf)      
)
pod_median <- median(patients_with_2R$POD, na.rm = TRUE)

# Add median-based POD split for comparison
pod_strata_median <- list(
  "Below Median POD" = c(0, pod_median),
  "Above Median POD" = c(pod_median + 1, Inf)
)

# Function to find significant results and create plots
perform_pod_plotting <- function(data, strata_list) {
  
  all_results <- list()
  
  for(stratum_name in names(strata_list)) {
    range_vals <- strata_list[[stratum_name]]
    
    # Filter data for this POD stratum
    stratum_data <- data %>%
      filter(POD >= range_vals[1] & POD <= range_vals[2])
    
    # Check sample size
    if(nrow(stratum_data) < 10) {
      next
    }
    
    # Create ACR groups
    acr_0_1r_stratum <- stratum_data %>%
      filter(ACR %in% c("0R", "1R")) %>%
      select(-H, -S, -POD, -Sample_ID, -ACR)
    
    acr_2r_stratum <- stratum_data %>%
      filter(grepl("^2R", ACR, ignore.case = TRUE)) %>%
      select(-H, -S, -POD, -Sample_ID, -ACR)
    
    if(nrow(acr_0_1r_stratum) < 3 | nrow(acr_2r_stratum) < 3) {
      next
    }
    
    # Perform Wilcoxon tests (most appropriate for metabolomics)
    acr_0_1r_log2_stratum <- acr_0_1r_stratum %>% mutate(across(everything(), ~ log2(.x + 0.001)))
    acr_2r_log2_stratum <- acr_2r_stratum %>% mutate(across(everything(), ~ log2(.x + 0.001)))
    
    wilcox_results <- lapply(seq_along(acr_0_1r_log2_stratum), function(i) {
      group1 <- acr_0_1r_log2_stratum[[i]]
      group2 <- acr_2r_log2_stratum[[i]]
      wilcox_test <- wilcox.test(group1, group2)
      tibble(
        Stratum = stratum_name,
        Metabolite = colnames(acr_0_1r_log2_stratum)[i],
        Median_0_1R = median(group1, na.rm = TRUE),
        Median_2R_plus = median(group2, na.rm = TRUE),
        median_diff = median(group2, na.rm = TRUE) - median(group1, na.rm = TRUE),
        p_value = wilcox_test$p.value
      )
    })
    wilcox_results <- bind_rows(wilcox_results) %>%
      mutate(FDR = p.adjust(p_value, method = "BH"))
    
    # Create plots for significant results (p < 0.1)
    sig_results <- wilcox_results %>% filter(p_value < 0.1)
    
    if(nrow(sig_results) > 0 && exists("plot_enhanced_bars")) {
      for (i in 1:nrow(sig_results)) {
        metabolite <- sig_results$Metabolite[i]
        p_val <- sig_results$p_value[i]
        
        # Create plot using enhanced function
        plot_title <- paste0("POD ", stratum_name, " - ", metabolite, " (p=", round(p_val, 3), ")")
        
        # Prepare data for plotting
        plot_data <- data.frame(
          Group = c(rep("0R/1R", nrow(acr_0_1r_stratum)), rep("2R+", nrow(acr_2r_stratum))),
          Value = c(acr_0_1r_stratum[[metabolite]], acr_2r_stratum[[metabolite]])
        )
        
        # Create plot
        p <- ggplot(plot_data, aes(x = Group, y = Value, fill = Group)) +
          geom_boxplot(alpha = 0.7) +
          geom_jitter(width = 0.2, alpha = 0.6) +
          labs(
            title = plot_title,
            subtitle = paste("Sample-Level Wilcoxon Test (Log2 data)"),
            y = "Median [Metabolite] Level",
            x = "ACR Status"
          ) +
          theme_minimal() +
          theme(legend.position = "none") +
          scale_fill_manual(values = c("0R/1R" = "lightblue", "2R+" = "lightcoral"))
        
        # Save plot
        filename <- paste0("./Immunosuppressive metabolites feature table/Results2/", 
                          gsub("[^A-Za-z0-9]", "_", stratum_name), "_", metabolite, "_Wilcoxon_plot.png")
        ggsave(filename, plot = p, dpi = 300, width = 8, height = 6)
      }
    }
    
    all_results[[stratum_name]] <- wilcox_results
  }
  
  return(all_results)
}

# Create plots for predefined strata
cat("Creating plots for predefined POD strata...\n")
results_predefined <- perform_pod_plotting(patients_with_2R, pod_strata)

# Create plots for median split (simple two-group comparison)
cat("Creating plots for median-split POD strata...\n")
results_median <- perform_pod_plotting(patients_with_2R, pod_strata_median)

#=== SUMMARY AND EXPORT ===

cat("\n=== SUMMARY ACROSS ALL STRATA ===\n")

# Create simple summary table
create_summary_table <- function(results_list, analysis_name) {
  summary_data <- map_dfr(names(results_list), function(stratum_name) {
    stratum_results <- results_list[[stratum_name]]
    
    tibble(
      Analysis = analysis_name,
      Stratum = stratum_name,
      Total_Metabolites = nrow(stratum_results),
      Significant_p01 = sum(stratum_results$p_value < 0.1, na.rm = TRUE),
      Significant_p005 = sum(stratum_results$p_value < 0.05, na.rm = TRUE),
      Significant_FDR005 = sum(stratum_results$FDR < 0.05, na.rm = TRUE)
    )
  })
  
  return(summary_data)
}

# Create summaries
all_summaries <- bind_rows(
  if(length(results_predefined) > 0) create_summary_table(results_predefined, "Predefined") else NULL,
  if(length(results_median) > 0) create_summary_table(results_median, "Median Split") else NULL
)

if(nrow(all_summaries) > 0) {
  cat("Summary of Significant Results by Stratum:\n")
  print(all_summaries)
  
  # Export results
  combined_results <- bind_rows(
    if(length(results_predefined) > 0) {
      map_dfr(names(results_predefined), ~ results_predefined[[.x]] %>% mutate(Analysis_Group = "Predefined"))
    } else NULL,
    if(length(results_median) > 0) {
      map_dfr(names(results_median), ~ results_median[[.x]] %>% mutate(Analysis_Group = "Median Split"))
    } else NULL
  )
  
  if(nrow(combined_results) > 0) {
    write_csv(combined_results, "Immunosuppressive metabolites feature table/Results2/POD_Stratified_With_Plots_Analysis.csv")
    write_csv(all_summaries, "Immunosuppressive metabolites feature table/Results2/POD_Stratified_With_Plots_Summary.csv")
    
    # Count plots created
    sig_results <- combined_results %>% filter(p_value < 0.1)
    cat("\nCreated", nrow(sig_results), "plots for significant POD-stratified results (p < 0.1).\n")
  }
}

cat("\n=== POD-STRATIFIED PLOTTING COMPLETE ===\n")

