#=== SIMPLIFIED POD-STRATIFIED ANALYSIS ===

cat("\n=== POD-STRATIFIED METABOLITE ANALYSIS ===\n")
cat("Performing Wilcoxon tests within each POD timepoint\n\n")


# Define POD strata
pod_quartiles <- quantile(patients_with_2R$POD, c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
pod_median <- median(patients_with_2R$POD, na.rm = TRUE)

pod_strata <- list(
  "Early (â‰¤30 days)" = c(0, 30),
  "Medium (31-90 days)" = c(31, 90), 
  "Late (91-180 days)" = c(91, 180),
  "Very Late (>180 days)" = c(181, Inf)
)

pod_strata_median <- list(
  "Below Median" = c(0, pod_median),
  "Above Median" = c(pod_median + 1, Inf)
)

# Function to perform simplified analysis within each POD stratum
perform_pod_stratified_analysis <- function(data, strata_list, strata_name) {
  
  all_stratum_results <- list()
  
  for(stratum_name in names(strata_list)) {
    range_vals <- strata_list[[stratum_name]]
    
    # Filter data for this POD stratum
    stratum_data <- data %>%
      filter(POD >= range_vals[1] & POD <= range_vals[2])
    
    # Check if we have enough samples
    if(nrow(stratum_data) < 10) {
      next
    }
    
    # Create ACR groups for this stratum
    acr_0_1r_stratum <- stratum_data %>%
      filter(ACR %in% c("0R", "1R")) %>%
      select(-H, -S, -POD, -Sample_ID, -ACR)
    
    acr_2r_stratum <- stratum_data %>%
      filter(grepl("^2R", ACR, ignore.case = TRUE)) %>%
      select(-H, -S, -POD, -Sample_ID, -ACR)
    
    if(nrow(acr_0_1r_stratum) < 3 | nrow(acr_2r_stratum) < 3) {
      next
    }
    
    # ANALYSIS: Wilcoxon tests (Log2 data) - Most appropriate for metabolomics
    acr_0_1r_log2_stratum <- acr_0_1r_stratum %>% mutate(across(everything(), ~ log2(.x + 0.001)))
    acr_2r_log2_stratum <- acr_2r_stratum %>% mutate(across(everything(), ~ log2(.x + 0.001)))
    
    wilcox_results <- lapply(seq_along(acr_0_1r_log2_stratum), function(i) {
      group1 <- acr_0_1r_log2_stratum[[i]]
      group2 <- acr_2r_log2_stratum[[i]]
      wilcox_test <- wilcox.test(group1, group2)
      tibble(
        Stratum = stratum_name,
        Metabolite = colnames(acr_0_1r_log2_stratum)[i],
        Median_0_1R = median(group1, na.rm = TRUE),
        Median_2R_plus = median(group2, na.rm = TRUE),
        median_diff = median(group2, na.rm = TRUE) - median(group1, na.rm = TRUE),
        p_value = wilcox_test$p.value
      )
    })
    wilcox_results <- bind_rows(wilcox_results) %>%
      mutate(FDR = p.adjust(p_value, method = "BH"))
    
    all_stratum_results[[stratum_name]] <- wilcox_results
  }
  
  return(all_stratum_results)
}

# Run analysis with predefined strata
results_predefined <- perform_pod_stratified_analysis(patients_with_2R, pod_strata, "Predefined Strata")

# Run analysis with median-based strata
results_median <- perform_pod_stratified_analysis(patients_with_2R, pod_strata_median, "Median Strata")

#=== SUMMARY ACROSS ALL STRATA ===

cat("\n\n=== SUMMARY ACROSS ALL STRATA ===\n")

# Create simple summary table
create_summary_table <- function(results_list, analysis_name) {
  summary_data <- map_dfr(names(results_list), function(stratum_name) {
    stratum_results <- results_list[[stratum_name]]
    
    tibble(
      Analysis = analysis_name,
      Stratum = stratum_name,
      Total_Metabolites = nrow(stratum_results),
      Significant_p005 = sum(stratum_results$p_value < 0.05, na.rm = TRUE),
      Significant_FDR005 = sum(stratum_results$FDR < 0.05, na.rm = TRUE),
      Min_Pvalue = round(min(stratum_results$p_value, na.rm = TRUE), 4)
    )
  })
  
  return(summary_data)
}

# Create summaries
all_summaries <- bind_rows(
  if(length(results_predefined) > 0) create_summary_table(results_predefined, "Predefined") else NULL,
  if(length(results_median) > 0) create_summary_table(results_median, "Median") else NULL
)

if(nrow(all_summaries) > 0) {
  cat("Summary of Significant Results by Stratum:\n")
  print(all_summaries)
  
  # Export results
  combined_results <- bind_rows(
    if(length(results_predefined) > 0) {
      map_dfr(names(results_predefined), ~ results_predefined[[.x]] %>% mutate(Analysis_Group = "Predefined"))
    } else NULL,
    if(length(results_median) > 0) {
      map_dfr(names(results_median), ~ results_median[[.x]] %>% mutate(Analysis_Group = "Median"))  
    } else NULL
  )
  
  if(nrow(combined_results) > 0) {
    write_csv(combined_results, "Immunosuppressive metabolites feature table/Results2/POD_Stratified_Complete_Analysis.csv")
    write_csv(all_summaries, "Immunosuppressive metabolites feature table/Results2/POD_Stratified_Summary.csv")
  }
} else {
  cat("No results to summarize.\n")
}

# Simple table creation for significant results
if(length(results_predefined) > 0 || length(results_median) > 0) {
  if (!requireNamespace("gtsummary", quietly = TRUE)) {
    install.packages("gtsummary")
  }
  library(gtsummary)
  library(flextable)
  
  # Create Table 1 for strata with significant results
  for(analysis_name in c("Predefined", "Median")) {
    results_list <- if(analysis_name == "Predefined") results_predefined else results_median
    
    for(stratum_name in names(results_list)) {
      stratum_data <- results_list[[stratum_name]]
      sig_results <- filter(stratum_data, p_value < 0.1)
      
      if(nrow(sig_results) > 0) {
        # Create simple table
        simple_table <- sig_results %>%
          select(Metabolite, Median_0_1R, Median_2R_plus, median_diff, p_value, FDR) %>%
          arrange(p_value)
        
        write_csv(simple_table, paste0("Immunosuppressive metabolites feature table/Results2/", 
                                      gsub("[^A-Za-z0-9]", "_", paste(analysis_name, stratum_name)), "_Results.csv"))
      }
    }
  }
}

cat("\n=== POD-STRATIFIED ANALYSIS COMPLETE ===\n")

