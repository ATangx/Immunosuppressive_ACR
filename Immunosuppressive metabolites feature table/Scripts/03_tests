
#=== SIMPLIFIED STATISTICAL ANALYSIS ===

#=== ANALYSIS 1: WILCOXON TESTS ON LOG2 DATA ===

#+ Perform Wilcoxon rank-sum tests between ACR 0/1R and 2R+ for each metabolite with median summaries
    ttest_res_median <- lapply(seq_along(acr_0_1r_log2), function(i) {
        group1 <- acr_0_1r_log2[[i]]
        group2 <- acr_2r_log2[[i]]
        wilcox_test <- wilcox.test(group1, group2)
        as_tibble(data.frame(
            Metabolite = colnames(acr_0_1r_log2)[i],
            Median_0_1R = median(group1, na.rm = TRUE),
            Median_2R_plus = median(group2, na.rm = TRUE),
            median_diff = median(group2, na.rm = TRUE) - median(group1, na.rm = TRUE),
            p_value = wilcox_test$p.value
        ))
    })
    ttest_res_median <- bind_rows(ttest_res_median)

#+ Plot bar graphs with the median for significant metabolites based on Wilcoxon tests
    sig_mets_median <- ttest_res_median %>%
        filter(p_value < 0.05)
    
    # Plot significant metabolites
    if (exists("plot_enhanced_bars") && nrow(sig_mets_median) > 0) {
        ttest_bars_median <- plot_enhanced_bars(sig_mets_median, acr_0_1r, acr_2r, 
                                               use_median = TRUE, analysis_level = "Sample-Level", 
                                               test_type = "Wilcoxon")
        
        # Save plots to files
        for (met in names(ttest_bars_median)) {
            ggsave(
                filename = paste0("./Immunosuppressive metabolites feature table/Results2/", met, "_Wilcoxon_plot_AT.png"),
                plot = ttest_bars_median[[met]],
                dpi = 300, width = 8, height = 6
            )
        }
    }


#=== ANALYSIS 3: WILCOXON TESTS ON NON-LOG2 DATA ===

#+ Perform Wilcoxon rank-sum tests on non-log2 data for comparison
    wilcox_res_nonlog2 <- lapply(seq_along(acr_0_1r), function(i) {
        group1 <- acr_0_1r[[i]]
        group2 <- acr_2r[[i]]
        wilcox_test <- wilcox.test(group1, group2)
        as_tibble(data.frame(
            Metabolite = colnames(acr_0_1r)[i],
            Median_0_1R = median(group1, na.rm = TRUE),
            Median_2R_plus = median(group2, na.rm = TRUE),
            median_diff = median(group2, na.rm = TRUE) - median(group1, na.rm = TRUE),
            p_value = wilcox_test$p.value
        ))
    })
    wilcox_res_nonlog2 <- bind_rows(wilcox_res_nonlog2)

    sig_mets_wilcox_nonlog2 <- wilcox_res_nonlog2 %>%
        filter(p_value < 0.05)
    
    # Plot significant metabolites
    if (exists("plot_enhanced_bars") && nrow(sig_mets_wilcox_nonlog2) > 0) {
        wilcox_bars_nonlog2 <- plot_enhanced_bars(sig_mets_wilcox_nonlog2, acr_0_1r, acr_2r, 
                                                  use_median = TRUE, analysis_level = "Sample-Level", 
                                                  test_type = "Wilcoxon")
        
        # Save plots to files
        for (met in names(wilcox_bars_nonlog2)) {
            ggsave(
                filename = paste0("./Immunosuppressive metabolites feature table/Results2/", met, "_Wilcoxon_NonLog2_plot_AT.png"),
                plot = wilcox_bars_nonlog2[[met]],
                dpi = 300, width = 8, height = 6
            )
        }
    }

#=== ANALYSIS 4: PATIENT-LEVEL ANALYSIS ===
#* Perform Wilcoxon rank-sum tests between ACR 0/1R and 2R+ at patient level
# NOTE: Full patient-level analysis is now in separate scripts (05a, 05b, 05c)

#=== SUMMARY TABLE: DESCRIPTIVE STATISTICS FOR ALL ANALYSES ===

#+ Create comprehensive summary table comparing all analyses
    final_summary <- tibble(
        `Analysis Method` = c("Wilcoxon (Log2)", "Wilcoxon (Non-log2)"),
        `Total Metabolites` = c(nrow(ttest_res_median), nrow(wilcox_res_nonlog2)),
        `Significant (p<0.05)` = c(
            sum(ttest_res_median$p_value < 0.05, na.rm = TRUE),
            sum(wilcox_res_nonlog2$p_value < 0.05, na.rm = TRUE)
        ),
        `% Significant` = round(c(
            (sum(ttest_res_median$p_value < 0.05, na.rm = TRUE) / nrow(ttest_res_median)) * 100,
            (sum(wilcox_res_nonlog2$p_value < 0.05, na.rm = TRUE) / nrow(wilcox_res_nonlog2)) * 100
        ), 1),
        `Min P-value` = c(
            round(min(ttest_res_median$p_value, na.rm = TRUE), 4),
            round(min(wilcox_res_nonlog2$p_value, na.rm = TRUE), 4)
        )
    )

#=== TABLE 1: METABOLITE LEVELS BY ACR STATUS ===

#+ Create publication-ready Table 1 showing metabolite levels by ACR group
    
    # Prepare data for Table 1
    table1_data <- patients_with_2R %>%
        mutate(
            ACR_Status = case_when(
                ACR %in% c("0R", "1R") ~ "0R/1R", 
                grepl("^2R", ACR, ignore.case = TRUE) ~ "2R+",
                TRUE ~ "Other"
            )
        ) %>%
        filter(ACR_Status %in% c("0R/1R", "2R+")) %>%
        select(-H, -S, -POD, -Sample_ID, -ACR) %>%
        mutate(ACR_Status = factor(ACR_Status, levels = c("0R/1R", "2R+")))
    
    # Create gtsummary Table 1
    metabolite_table1 <- table1_data %>%
        gtsummary::tbl_summary(
            by = ACR_Status,
            include = where(is.numeric),
            type = list(where(is.numeric) ~ "continuous"),
            statistic = list(all_continuous() ~ "{mean} ({sd}); {median} [{p25}, {p75}]"),
            missing = "no",
            digits = list(all_continuous() ~ 2)
        ) %>%
        gtsummary::add_p(test = list(all_continuous() ~ "wilcox.test")) %>%
        gtsummary::modify_spanning_header(c("stat_1", "stat_2") ~ "**ACR Status**") %>%
        gtsummary::modify_caption("**Table 1: Metabolite Levels by ACR Status**")
    
    # Export Table 1
    tryCatch({
        flex_table1 <- metabolite_table1 %>%
            gtsummary::as_flex_table() %>%
            flextable::set_caption("Table 1: Metabolite Levels by ACR Status") %>%
            flextable::autofit()
        
        flex_table1 %>%
            flextable::save_as_docx(path = "./Immunosuppressive metabolites feature table/Results2/Table1_Metabolite_Levels_By_ACR_Status.docx")
        
    }, error = function(e) {
        write.csv(table1_data, 
                  "./Immunosuppressive metabolites feature table/Results2/Table1_Raw_Data.csv", 
                  row.names = FALSE)
    })

#=== CREATE CLINICAL FORMAT TABLES FOR ALL ANALYSES ===

#+ Create clinical format tables (like Table 1 style) for all analyses
    
    # Format Wilcoxon (Log2) Results in Clinical Style  
    wilcox_log2_clinical <- ttest_res_median %>%
        arrange(p_value) %>%
        mutate(
            `0R/1R Group` = paste0(round(2^Median_0_1R, 1)),
            `2R+ Group` = paste0(round(2^Median_2R_plus, 1)),
            `p-value` = round(p_value, 3)
        ) %>%
        select(Metabolite, `0R/1R Group`, `2R+ Group`, `p-value`)
    
    # Format Wilcoxon (Non-log2) Results in Clinical Style
    wilcox_nonlog2_clinical <- wilcox_res_nonlog2 %>%
        arrange(p_value) %>%
        mutate(
            `0R/1R Group` = paste0(round(Median_0_1R, 1)),
            `2R+ Group` = paste0(round(Median_2R_plus, 1)),
            `p-value` = round(p_value, 3)
        ) %>%
        select(Metabolite, `0R/1R Group`, `2R+ Group`, `p-value`)
    
    # Export clinical format tables
    tryCatch({
        clinical_wilcox_log2_table <- wilcox_log2_clinical %>%
            flextable::flextable() %>%
            flextable::set_caption("Clinical Table: Wilcoxon Results (Log2 Data)") %>%
            flextable::theme_vanilla() %>%
            flextable::autofit()
        
        clinical_wilcox_nonlog2_table <- wilcox_nonlog2_clinical %>%
            flextable::flextable() %>%
            flextable::set_caption("Clinical Table: Wilcoxon Results (Non-log2 Data)") %>%
            flextable::theme_vanilla() %>%
            flextable::autofit()
        
        # Create combined document
        doc <- officer::read_docx()
        doc <- flextable::body_add_flextable(doc, clinical_wilcox_log2_table)
        doc <- officer::body_add_break(doc)
        doc <- flextable::body_add_flextable(doc, clinical_wilcox_nonlog2_table)
        
        print(doc, target = "./Immunosuppressive metabolites feature table/Results2/Metabolomics_Clinical_Format_All_Tables.docx")
        
    }, error = function(e) {
        # Save as CSV if Word export fails
        write.csv(wilcox_log2_clinical, "./Immunosuppressive metabolites feature table/Results2/Clinical_Wilcoxon_Log2_Results.csv", row.names = FALSE)
        write.csv(wilcox_nonlog2_clinical, "./Immunosuppressive metabolites feature table/Results2/Clinical_Wilcoxon_NonLog2_Results.csv", row.names = FALSE)
    })


# # Display all tables in the console for review

