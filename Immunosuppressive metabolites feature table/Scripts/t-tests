#* Perform t-tests between ACR 0/1R and 2R+ for each metabolite
    ttest_res <- lapply(seq_along(acr_0_1r), function(i) {
    ttest <- t.test(acr_0_1r[[i]], acr_2r[[i]])
    as.tibble(data.frame(
        Metabolite = colnames(acr_0_1r)[i],
        Mean_0_1R = mean(acr_0_1r[[i]], na.rm = TRUE),
        Mean_2R_plus = mean(acr_2r[[i]], na.rm = TRUE),
        mean_diff = diff(ttest$estimate),
        p_value = ttest$p.value
        ))
    })
    ttest_res <- bind_rows(ttest_res)

#* Plot bar graphs with dot plots for significant metabolites
    sig_mets <- ttest_res %>%
      filter(p_value < 0.05)
    
    # Check if plot_ttest_bars function exists, if not skip plotting
    if (exists("plot_ttest_bars")) {
        ttest_bars <- plot_ttest_bars(sig_mets, acr_0_1r, acr_2r)
        
        #* OPTIONAL: Save plots to files
        for (met in names(ttest_bars)) {
            ggsave(
                filename = paste0("./Immunosuppressive metabolites feature table/Results/", met, "_ACR_plot_AT.png"),
                plot = ttest_bars[[met]],
                dpi = 300
            )
        }
    } else {
        cat("Warning: plot_ttest_bars function not found. Skipping mean plots.\n")
        cat("Number of significant metabolites (t-test):", nrow(sig_mets), "\n")
    }

#! Experimenting with medians instead of means for t-test summaries

#* Perform Wilcoxon rank-sum tests between ACR 0/1R and 2R+ for each metabolite with median summaries
    ttest_res_median <- lapply(seq_along(acr_0_1r), function(i) {
    group1 <- acr_0_1r[[i]]
    group2 <- acr_2r[[i]]
    median1 <- median(group1, na.rm = TRUE)
    median2 <- median(group2, na.rm = TRUE)
    median_diff <- median2 - median1
    # Perform Wilcoxon rank-sum test (non-parametric alternative to t-test)
    wilcox_test <- wilcox.test(group1, group2)
    as_tibble(data.frame(
        Metabolite = colnames(acr_0_1r)[i],
        Median_0_1R = median1,
        Median_2R_plus = median2,
        median_diff = median_diff,
        p_value = wilcox_test$p.value
        ))
    })
    ttest_res_median <- bind_rows(ttest_res_median)

#* Plot bar graphs with the median for significant metabolites based on Wilcoxon tests
    sig_mets_median <- ttest_res_median %>%
      filter(p_value < 0.05)
    
    # Check if plot_ttest_bars function exists, if not skip plotting for now
    if (exists("plot_ttest_bars")) {
        ttest_bars_median <- plot_ttest_bars(sig_mets_median, acr_0_1r, acr_2r, use_median = TRUE)
    } else {
        cat("Warning: plot_ttest_bars function not found. Skipping median plots.\n")
        cat("Number of significant metabolites (Wilcoxon test):", nrow(sig_mets_median), "\n")
    }

#! Now try to aggregate to patient level before testing with medians
#* Perform Wilcoxon rank-sum tests between ACR 0/1R and 2R+ at patient level
    # Aggregate to patient level by taking median per patient
    acr_0_1r_patient <- patients_with_2R %>%
    filter(ACR %in% c("0R", "1R")) %>%
    group_by(H) %>%
    summarise(
        across(where(is.numeric), \(x) median(x, na.rm = TRUE)),
        .groups = "drop"
    )

    acr_2r_patient <- patients_with_2R %>%
    filter(grepl("^2R", ACR, ignore.case = TRUE)) %>%
    group_by(H) %>%
    summarise(
        across(where(is.numeric), \(x) median(x, na.rm = TRUE)),
        .groups = "drop"
    )

    # Get common columns and exclude metadata columns (H, POD, S, etc.)
    common_mets <- intersect(
    colnames(acr_0_1r_patient),
    colnames(acr_2r_patient)
    )

    # Exclude metadata columns - keep only actual metabolite columns
    metadata_cols <- c("H", "POD", "S", "Sample_ID")
    common_mets <- setdiff(common_mets, metadata_cols)
    
    # Display what metabolites will be tested
    cat("Testing", length(common_mets), "metabolites at patient level:\n")
    cat("First 10 metabolites:", head(common_mets, 10), "\n\n")

    ttest_res_median_patient <- lapply(common_mets, function(met) {

    group1 <- acr_0_1r_patient[[met]]
    group2 <- acr_2r_patient[[met]]

    # check samples group1 and group2 sizes
    cat("Testing metabolite:", met, "\n")
    cat("Group 1 (0R/1R) samples:", sum(!is.na(group1)), "\n")
    cat("Group 2 (2R+) samples:", sum(!is.na(group2)), "\n")

    wilcox_test <- wilcox.test(group1, group2)

    tibble(
        Metabolite = met,
        Median_0_1R = median(group1, na.rm = TRUE),
        Median_2R_plus = median(group2, na.rm = TRUE),
        median_diff = median(group2, na.rm = TRUE) - median(group1, na.rm = TRUE),
        p_value = wilcox_test$p.value
    )
    })

    ttest_res_median_patient <- bind_rows(ttest_res_median_patient)

    ttest_res_median_patient <- ttest_res_median_patient %>%
    mutate(FDR = p.adjust(p_value, method = "BH"))
#* OPTIONAL: Report significant metabolites at patient level based on Wilcoxon tests
    sig_mets_median_patient <- ttest_res_median_patient %>%
      filter(p_value < 0.05)
    cat("Number of significant metabolites at patient level (Wilcoxon test):", nrow(sig_mets_median_patient), "\n")
    print(sig_mets_median_patient)

#* Report metabolites at patient level regardless of significance
    cat("All metabolites tested at patient level:\n")
    print(ttest_res_median_patient)


#* OPTIONAL: Plot bar graphs with the median for significant metabolites at patient level
    if (exists("plot_ttest_bars")) {
        ttest_bars_median_patient <- plot_ttest_bars(sig_mets_median_patient, acr_0_1r_patient %>% select(-H), acr_2r_patient %>% select(-H), use_median = TRUE)
    } else {
        cat("Warning: plot_ttest_bars function not found. Skipping patient-level median plots.\n")
    }




    #!old
#     acr_0_1r_patient <- acr_0_1r %>%
#       mutate(Patient_ID = patients_with_2R$H) %>%
#       group_by(Patient_ID) %>%
#       summarise(across(everything(), median, na.rm = TRUE)) %>%
#       ungroup() %>%
#       select(-Patient_ID)
    
#     acr_2r_patient <- acr_2r %>%
#       mutate(Patient_ID = patients_with_2R$H) %>%
#       group_by(Patient_ID) %>%
#       summarise(across(everything(), median, na.rm = TRUE)) %>%
#       ungroup() %>%
#       select(-Patient_ID)
    
#     ttest_res_median_patient <- lapply(seq_along(acr_0_1r_patient), function(i) {
#     group1 <- acr_0_1r_patient[[i]]
#     group2 <- acr_2r_patient[[i]]
#     median1 <- median(group1, na.rm = TRUE)
#     median2 <- median(group2, na.rm = TRUE)
#     median_diff <- median2 - median1
#     wilcox_test <- wilcox.test(group1, group2)
#     as_tibble(data.frame(
#         Metabolite = colnames(acr_0_1r_patient)[i],
#         Median_0_1R = median1,
#         Median_2R_plus = median2,
#         median_diff = median_diff,
#         p_value = wilcox_test$p.value
#         ))
#     })
#     ttest_res_median_patient <- bind_rows(ttest_res_median_patient)

# #* Report significant metabolites at patient level based on Wilcoxon tests
#     sig_mets_median_patient <- ttest_res_median_patient %>%
#       filter(p_value < 0.05)
#     cat("Number of significant metabolites at patient level (Wilcoxon test):", nrow(sig_mets_median_patient), "\n")
#     print(sig_mets_median_patient)

# #* OPTIONAL: Plot bar graphs with the median for significant metabolites at patient level
#     if (exists("plot_ttest_bars")) {
#         ttest_bars_median_patient <- plot_ttest_bars(sig_mets_median_patient, acr_0_1r_patient, acr_2r_patient, use_median = TRUE)
#     } else {
#         cat("Warning: plot_ttest_bars function not found. Skipping patient-level median plots.\n")
#     }