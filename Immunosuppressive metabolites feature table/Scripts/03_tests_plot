#=== COMPREHENSIVE PLOTTING FOR 03_TESTS RESULTS ===

# Source the analysis results first
source("Immunosuppressive metabolites feature table/Scripts/03_tests")

library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)
library(scales)

cat("\n=== CREATING COMPREHENSIVE PLOTS FOR ALL ANALYSES ===\n")

#=== 1. VOLCANO PLOTS FOR EACH ANALYSIS ===

#+ Create volcano plots showing effect size vs significance
create_volcano_plot <- function(results_df, title, effect_col, pval_col = "p_value") {
    results_df %>%
        mutate(
            log10_p = -log10(.data[[pval_col]]),
            significant = ifelse(.data[[pval_col]] < 0.05, "Significant", "Not Significant"),
            effect_size = abs(.data[[effect_col]])
        ) %>%
        ggplot(aes(x = .data[[effect_col]], y = log10_p)) +
        geom_point(aes(color = significant), alpha = 0.7, size = 3) +
        geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red", size = 1) +
        geom_vline(xintercept = 0, linetype = "solid", color = "gray50", alpha = 0.5) +
        scale_color_manual(values = c("Significant" = "red", "Not Significant" = "gray60")) +
        labs(
            title = paste("Volcano Plot:", title),
            subtitle = paste("Horizontal line: p = 0.05 threshold"),
            x = "Effect Size (Log2 Fold Change or Median Difference)",
            y = "-log10(p-value)",
            color = "Significance"
        ) +
        theme_minimal() +
        theme(
            plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
            plot.subtitle = element_text(hjust = 0.5, size = 12),
            legend.position = "bottom"
        )
}

# Create volcano plots for each analysis
cat("Creating volcano plots...\n")
volcano_ttest <- create_volcano_plot(ttest_res, "T-tests (Log2)", "mean_diff_log2")
volcano_wilcox_log2 <- create_volcano_plot(ttest_res_median, "Wilcoxon (Log2)", "median_diff")  
volcano_wilcox_nonlog2 <- create_volcano_plot(wilcox_res_nonlog2, "Wilcoxon (Non-log2)", "median_diff")
volcano_patient <- create_volcano_plot(ttest_res_median_patient, "Patient-level", "median_diff")

#=== 2. P-VALUE DISTRIBUTION PLOTS ===

#+ Create p-value histograms to check for proper distribution
cat("Creating p-value distribution plots...\n")
pval_plots <- list(
    ttest_res %>% mutate(Analysis = "T-tests (Log2)"),
    ttest_res_median %>% mutate(Analysis = "Wilcoxon (Log2)"),
    wilcox_res_nonlog2 %>% mutate(Analysis = "Wilcoxon (Non-log2)"),
    ttest_res_median_patient %>% mutate(Analysis = "Patient-level")
) %>%
    bind_rows() %>%
    ggplot(aes(x = p_value)) +
    geom_histogram(bins = 20, fill = "skyblue", alpha = 0.7, color = "black") +
    geom_vline(xintercept = 0.05, color = "red", linetype = "dashed", size = 1) +
    facet_wrap(~ Analysis, scales = "free_y") +
    labs(
        title = "P-value Distribution Across All Analyses",
        subtitle = "Red line: p = 0.05 significance threshold",
        x = "P-value",
        y = "Count"
    ) +
    theme_minimal() +
    theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        strip.text = element_text(size = 12, face = "bold")
    )

#=== 3. EFFECT SIZE COMPARISON PLOTS ===

#+ Compare effect sizes across different analyses
cat("Creating effect size comparison plots...\n")
effect_comparison_data <- bind_rows(
    ttest_res %>% 
        select(Metabolite, mean_diff_log2) %>%
        rename(Effect_Size = mean_diff_log2) %>%
        mutate(Analysis = "T-tests (Log2)"),
    ttest_res_median %>% 
        select(Metabolite, median_diff) %>%
        rename(Effect_Size = median_diff) %>%
        mutate(Analysis = "Wilcoxon (Log2)"),
    wilcox_res_nonlog2 %>% 
        select(Metabolite, median_diff) %>%
        rename(Effect_Size = median_diff) %>%
        mutate(Analysis = "Wilcoxon (Non-log2)"),
    ttest_res_median_patient %>% 
        select(Metabolite, median_diff) %>%
        rename(Effect_Size = median_diff) %>%
        mutate(Analysis = "Patient-level")
)

effect_comparison_plot <- effect_comparison_data %>%
    ggplot(aes(x = Analysis, y = Effect_Size, fill = Analysis)) +
    geom_boxplot(alpha = 0.7, outlier.alpha = 0.5) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    scale_fill_brewer(type = "qual", palette = "Set2") +
    labs(
        title = "Effect Size Distribution Across Analyses",
        subtitle = "Comparison of effect sizes from different statistical approaches",
        x = "Analysis Method",
        y = "Effect Size",
        fill = "Analysis"
    ) +
    theme_minimal() +
    theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none"
    )

#=== 4. CORRELATION BETWEEN ANALYSES ===

#+ Create correlation plots between different analysis methods
cat("Creating correlation plots between analyses...\n")

# Prepare data for correlation analysis
correlation_data <- ttest_res %>%
    select(Metabolite, mean_diff_log2, p_value) %>%
    rename(TTest_Effect = mean_diff_log2, TTest_P = p_value) %>%
    left_join(
        ttest_res_median %>% 
        select(Metabolite, median_diff, p_value) %>%
        rename(Wilcox_Log2_Effect = median_diff, Wilcox_Log2_P = p_value),
        by = "Metabolite"
    ) %>%
    left_join(
        wilcox_res_nonlog2 %>% 
        select(Metabolite, median_diff, p_value) %>%
        rename(Wilcox_NonLog2_Effect = median_diff, Wilcox_NonLog2_P = p_value),
        by = "Metabolite"
    ) %>%
    left_join(
        ttest_res_median_patient %>% 
        select(Metabolite, median_diff, p_value) %>%
        rename(Patient_Effect = median_diff, Patient_P = p_value),
        by = "Metabolite"
    )

# Effect size correlations
effect_corr_plot <- correlation_data %>%
    select(Metabolite, TTest_Effect, Wilcox_Log2_Effect, Wilcox_NonLog2_Effect, Patient_Effect) %>%
    pivot_longer(cols = -Metabolite, names_to = "Analysis", values_to = "Effect_Size") %>%
    pivot_wider(names_from = Analysis, values_from = Effect_Size) %>%
    select(-Metabolite) %>%
    cor(use = "complete.obs") %>%
    as.data.frame() %>%
    rownames_to_column("Analysis1") %>%
    pivot_longer(cols = -Analysis1, names_to = "Analysis2", values_to = "Correlation") %>%
    ggplot(aes(x = Analysis1, y = Analysis2, fill = Correlation)) +
    geom_tile(color = "white") +
    geom_text(aes(label = round(Correlation, 2)), color = "white", size = 4, fontface = "bold") +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0,
                        limit = c(-1,1), name = "Correlation") +
    labs(
        title = "Effect Size Correlations Between Analyses",
        subtitle = "Pearson correlation coefficients",
        x = "Analysis Method",
        y = "Analysis Method"
    ) +
    theme_minimal() +
    theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(angle = 45, hjust = 1)
    )

#=== 5. SIGNIFICANCE SUMMARY PLOT ===

#+ Create bar plot showing number of significant metabolites per analysis
cat("Creating significance summary plot...\n")
significance_summary_data <- tibble(
    Analysis = c("T-tests\n(Log2)", "Wilcoxon\n(Log2)", "Wilcoxon\n(Non-log2)", "Patient-level"),
    N_Significant = c(
        sum(ttest_res$p_value < 0.05, na.rm = TRUE),
        sum(ttest_res_median$p_value < 0.05, na.rm = TRUE),
        sum(wilcox_res_nonlog2$p_value < 0.05, na.rm = TRUE),
        sum(ttest_res_median_patient$p_value < 0.05, na.rm = TRUE)
    ),
    N_Total = c(
        nrow(ttest_res),
        nrow(ttest_res_median),
        nrow(wilcox_res_nonlog2),
        nrow(ttest_res_median_patient)
    ),
    Percentage = round((N_Significant / N_Total) * 100, 1)
)

significance_plot <- significance_summary_data %>%
    ggplot(aes(x = Analysis, y = N_Significant, fill = Analysis)) +
    geom_col(alpha = 0.8, color = "black") +
    geom_text(aes(label = paste0(N_Significant, "\n(", Percentage, "%)")), 
              vjust = -0.5, fontface = "bold", size = 4) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
    labs(
        title = "Significant Metabolites by Analysis Method",
        subtitle = "Number and percentage of significant metabolites (p < 0.05)",
        x = "Analysis Method",
        y = "Number of Significant Metabolites",
        fill = "Analysis"
    ) +
    theme_minimal() +
    theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        legend.position = "none"
    )

#=== 6. TOP METABOLITES HEATMAP ===

#+ Create heatmap of top metabolites across all analyses
cat("Creating top metabolites heatmap...\n")

# Get top 10 most significant metabolites from each analysis
get_top_metabolites <- function(df, n = 10) {
    df %>%
        arrange(p_value) %>%
        head(n) %>%
        pull(Metabolite)
}

top_metabolites <- unique(c(
    get_top_metabolites(ttest_res),
    get_top_metabolites(ttest_res_median),
    get_top_metabolites(wilcox_res_nonlog2),
    get_top_metabolites(ttest_res_median_patient)
))

# Create heatmap data
heatmap_data <- bind_rows(
    ttest_res %>% filter(Metabolite %in% top_metabolites) %>%
        select(Metabolite, p_value) %>% mutate(Analysis = "T-tests (Log2)"),
    ttest_res_median %>% filter(Metabolite %in% top_metabolites) %>%
        select(Metabolite, p_value) %>% mutate(Analysis = "Wilcoxon (Log2)"),
    wilcox_res_nonlog2 %>% filter(Metabolite %in% top_metabolites) %>%
        select(Metabolite, p_value) %>% mutate(Analysis = "Wilcoxon (Non-log2)"),
    ttest_res_median_patient %>% filter(Metabolite %in% top_metabolites) %>%
        select(Metabolite, p_value) %>% mutate(Analysis = "Patient-level")
) %>%
    mutate(
        log10_p = -log10(p_value),
        Significance = case_when(
            p_value < 0.001 ~ "***",
            p_value < 0.01 ~ "**", 
            p_value < 0.05 ~ "*",
            TRUE ~ "ns"
        )
    )

heatmap_plot <- heatmap_data %>%
    ggplot(aes(x = Analysis, y = Metabolite, fill = log10_p)) +
    geom_tile(color = "white", size = 0.5) +
    geom_text(aes(label = Significance), color = "white", fontface = "bold", size = 3) +
    scale_fill_gradient(low = "lightblue", high = "darkred", name = "-log10(p)") +
    labs(
        title = "Top Metabolites P-value Heatmap",
        subtitle = "*** p<0.001, ** p<0.01, * p<0.05, ns = not significant",
        x = "Analysis Method",
        y = "Metabolite"
    ) +
    theme_minimal() +
    theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)
    )

#=== 7. SAVE ALL PLOTS ===

cat("Saving comprehensive analysis plots...\n")

# Create output directory
dir.create("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots", 
           showWarnings = FALSE, recursive = TRUE)

# Save individual plots
ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/01_Volcano_TTests_Log2.png",
       volcano_ttest, width = 10, height = 8, dpi = 300)

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/02_Volcano_Wilcoxon_Log2.png",
       volcano_wilcox_log2, width = 10, height = 8, dpi = 300)

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/03_Volcano_Wilcoxon_NonLog2.png",
       volcano_wilcox_nonlog2, width = 10, height = 8, dpi = 300)

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/04_Volcano_Patient_Level.png",
       volcano_patient, width = 10, height = 8, dpi = 300)

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/05_PValue_Distribution.png",
       pval_plots, width = 12, height = 8, dpi = 300)

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/06_Effect_Size_Comparison.png",
       effect_comparison_plot, width = 10, height = 8, dpi = 300)

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/07_Effect_Size_Correlations.png",
       effect_corr_plot, width = 10, height = 8, dpi = 300)

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/08_Significance_Summary.png",
       significance_plot, width = 10, height = 8, dpi = 300)

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/09_Top_Metabolites_Heatmap.png",
       heatmap_plot, width = 12, height = 10, dpi = 300)

#=== 8. CREATE COMBINED FIGURE ===

cat("Creating combined summary figure...\n")

# Combine key plots into a single figure
combined_plot <- (volcano_ttest + volcano_wilcox_log2) /
                 (significance_plot + effect_comparison_plot) +
                 plot_annotation(
                     title = "Comprehensive Metabolomics Analysis Summary",
                     subtitle = "Comparison of T-tests vs Wilcoxon tests on Log2 transformed data",
                     theme = theme(
                         plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
                         plot.subtitle = element_text(hjust = 0.5, size = 14)
                     )
                 )

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/00_Combined_Summary_Figure.png",
       combined_plot, width = 16, height = 12, dpi = 300)

#=== 9. CREATE SUPPLEMENTARY ANALYSIS FIGURE ===

cat("Creating supplementary analysis figure...\n")

# Combine supplementary plots
supplementary_plot <- (pval_plots) /
                     (effect_corr_plot + heatmap_plot) +
                     plot_annotation(
                         title = "Supplementary Analysis: Method Comparison and Top Results",
                         subtitle = "P-value distributions, correlations, and top metabolites across all analyses",
                         theme = theme(
                             plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
                             plot.subtitle = element_text(hjust = 0.5, size = 14)
                         )
                     )

ggsave("./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/10_Supplementary_Analysis.png",
       supplementary_plot, width = 16, height = 12, dpi = 300)

#=== 10. PRINT SUMMARY ===

cat("\n=== PLOTTING COMPLETE ===\n")
cat("Created comprehensive visualization plots for all analyses:\n")
cat("1. Individual volcano plots for each analysis method\n")
cat("2. P-value distribution plots\n")
cat("3. Effect size comparison across methods\n") 
cat("4. Correlation analysis between methods\n")
cat("5. Significance summary bar plot\n")
cat("6. Top metabolites heatmap\n")
cat("7. Combined summary figure (main)\n")
cat("8. Supplementary analysis figure\n")
cat("\nAll plots saved to: ./Immunosuppressive metabolites feature table/Results/Dump_122325/Analysis_Plots/\n")

# Display significance summary
cat("\n--- SIGNIFICANCE SUMMARY ---\n")
print(significance_summary_data)

cat("\n--- TOP METABOLITES ACROSS ALL ANALYSES ---\n")
cat("Top metabolites by lowest p-value in each analysis:\n")
cat("T-tests (Log2):", paste(get_top_metabolites(ttest_res, 3), collapse = ", "), "\n")
cat("Wilcoxon (Log2):", paste(get_top_metabolites(ttest_res_median, 3), collapse = ", "), "\n")
cat("Wilcoxon (Non-log2):", paste(get_top_metabolites(wilcox_res_nonlog2, 3), collapse = ", "), "\n")
cat("Patient-level:", paste(get_top_metabolites(ttest_res_median_patient, 3), collapse = ", "), "\n")

cat("\n=== COMPREHENSIVE PLOTTING ANALYSIS COMPLETE ===\n")
